container_commands:
  01_enable_swap:
    command: |
      sudo fallocate -l 1G /swapfile
      sudo chmod 600 /swapfile
      sudo mkswap /swapfile
      sudo swapon /swapfile
      echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
  02_install_dependencies:
    command: |
      sudo yum update -y
      sudo yum install -y nginx
      sudo amazon-linux-extras enable epel
      sudo yum install -y epel-release
      sudo yum install -y certbot python2-certbot-nginx
  03_configure_nginx:
    command: |
      sudo sed -i '/http {/a \    server_names_hash_bucket_size 128;' /etc/nginx/nginx.conf
  04_start_nginx:
    command: |
      sudo systemctl start nginx
      sudo systemctl enable nginx
  05_certbot_setup:
    command: |
      sudo certbot --nginx -d flask-app-server-env.ap-south-1.elasticbeanstalk.com -d bk.flask-app-server-env.ap-south-1.elasticbeanstalk.com --non-interactive --agree-tos -m singhaadi2004@gmail.com
  06_restart_nginx:
    command: sudo systemctl restart nginx
  07_certbot_renew_cron:
    command: |
      echo "0 0, 12 * * * root /opt/certbot/bin/python -c 'import random; import time; time.sleep(random.random() * 3600)' && sudo certbot renew -q" | sudo tee -a /etc/crontab > /dev/null
